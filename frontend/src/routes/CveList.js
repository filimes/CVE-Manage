import React, { useEffect, useState } from 'react';
import axios from 'axios';
import { useNavigate } from 'react-router-dom';
import SelectedCVE from '../components/SelectedCVE';
import './css/CveList.css';
import targetColors from '../utils/targetColors';

const CVEList = () => {
	const [cveData, setCveData] = useState([]);
	const [searchTerm, setSearchTerm] = useState('');
	const [selectedCVE, setSelectedCVE] = useState([]);
	const navigate = useNavigate();

	useEffect(() => {
		const fetchCVEData = async () => {
			try {
				// http://localhost:5000
				const response = await axios.get('http://localhost:5000/api/cve');
				const formattedData = Object.entries(response.data).map(
					([key, value]) => ({
						key: key.replace('cve:', ''),
						...value
					})
				);
				setCveData(formattedData);
			} catch (error) {
				console.error('Error fetching the CVE data', error);
			}
		};
		fetchCVEData();

		const storedSelectedCVE =
			JSON.parse(localStorage.getItem('selectedCVE')) || [];
		setSelectedCVE(storedSelectedCVE);
	}, []);

	const handleSearch = async () => {
		try {
			if (searchTerm.trim() === '') {
				const response = await axios.get('http://localhost:5000/api/cve');
				const formattedData = Object.entries(response.data).map(
					([key, value]) => ({
						key: key.replace('cve:', ''),
						...value
					})
				);
				setCveData(formattedData);
			} else {
				const response = await axios.get(`/api/cve/get?search=${searchTerm}`);
				const formattedData = Object.entries(response.data).map(
					([key, value]) => ({
						key: key.replace('cve:', ''),
						...value
					})
				);
				setCveData(formattedData);
			}
		} catch (error) {
			if (error.response && error.response.status === 404) {
				console.error('No results found');
				setCveData([]);
			} else {
				console.error('Error fetching CVE data');
			}
		}
	};

	const handleSelectCVE = cveKey => {
		let updatedSelectedCVE;

		if (selectedCVE.includes(cveKey)) {
			updatedSelectedCVE = selectedCVE.filter(key => key !== cveKey);
		} else {
			updatedSelectedCVE = [...selectedCVE, cveKey];
		}

		setSelectedCVE(updatedSelectedCVE);
		localStorage.setItem('selectedCVE', JSON.stringify(updatedSelectedCVE));
	};

	const handleRemoveCVE = cveKey => {
		const updatedSelectedCVE = selectedCVE.filter(key => key !== cveKey);
		setSelectedCVE(updatedSelectedCVE);
		localStorage.setItem('selectedCVE', JSON.stringify(updatedSelectedCVE));
	};

	const handleCveClick = cveName => {
		navigate(`/cve/${cveName}`);
	};

	return (
		<div className="cve-list-and-selected">
			<div className="selected-cve-container">
				<SelectedCVE
					selectedCVE={selectedCVE}
					handleRemoveCVE={handleRemoveCVE}
				/>
			</div>
			<div className="cve-list-container">
				<div className="search-bar">
					<input
						type="text"
						placeholder="Search CVE"
						value={searchTerm}
						onChange={e => setSearchTerm(e.target.value)}
					/>
					<button onClick={handleSearch}>Search</button>
				</div>

				{cveData.map(cve => (
					<div key={cve.key} className="cve-card">
						<div className="cve-badges">
							<span
								className="badge"
								style={{ backgroundColor: targetColors[cve.target] || 'gray' }} // 타겟별 색상 적용
							>
								{cve.target}
							</span>
							<span className="badge badge-risk">{cve.risk}</span>
						</div>
						<a
							href="#"
							className="cve-title"
							onClick={() => handleCveClick(cve.key)}
						>
							{cve.key}
						</a>
						<p className="cve-summary">{cve.summary}</p>
						<button
							className={`select-button ${
								selectedCVE.includes(cve.key) ? 'selected' : ''
							}`}
							onClick={() => handleSelectCVE(cve.key)}
						>
							{selectedCVE.includes(cve.key) ? 'Selected' : 'Select'}
						</button>
					</div>
				))}
			</div>
		</div>
	);
};

export default CVEList;
