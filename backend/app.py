from flask import Flask, session, jsonify, request
# from flask_cors import CORS
import redis
import subprocess
import os
import json

app = Flask(__name__)
# host='redis'
r = redis.StrictRedis(host='redis', port=6379, decode_responses=True)

PROXY_PORT = 9000
env = os.environ.copy()
env["HTTP_PROXY"] = f"http://proxy:{PROXY_PORT}"
env["HTTPS_PROXY"] = f"http://proxy:{PROXY_PORT}"

@app.route('/api/cve', methods=['GET'])
def main():
    cve_keys = r.keys('cve:*')

    cve_data = {}

    for key in cve_keys:
        cve_data[key] = r.hgetall(key)

    return jsonify(cve_data)

@app.route('/api/cve/get', methods=['GET'])
def get_cve():
    search_value = request.args.get('search', '').lower() 
    if not search_value:
        return jsonify({"message": "Search value is required"}), 400

    cve_keys = r.keys('cve:*')
    results = {}

    for key in cve_keys:
        cve_data = r.hgetall(key)

        if any(search_value in value.lower() for value in cve_data.values()) or (search_value.lower() in key.lower()):
            results[key] = cve_data

    if results:
        return jsonify(results)
    else:
        return jsonify({"message": "No matching CVE found"}), 404
    
@app.route('/api/cve/<cveName>', methods=['GET'])
def get_cve_by_key(cveName):
    try:
        cve_data = r.hgetall(f'cve:{cveName}')
        
        if not cve_data:
            return jsonify({"error": "CVE not found"}), 404

        try:
            with open(f'./cve/{cveName}/poc.py', 'r') as file:
                poc_content = file.read()
            cve_data['poc'] = poc_content
        except:
            pass
        
        return jsonify(cve_data)

    except Exception as e:
        print(f"Error retrieving CVE data: {e}")
        return jsonify({"error": "Internal server error"}), 500
    
@app.route('/api/attack', methods=['POST'])
def run_cve():
    data = request.get_json()
    cve_name = data.get('cve')
    url = data.get('url') 
    port = data.get('port')
    
    requirement_name = f"./cve/{cve_name}/requirements.txt"
    script_name = f"./cve/{cve_name}/poc.py"
    
    command = ["python3", script_name]
    
    if url:
        command.extend(["-u", url])
    if port:
        command.extend(["-p", port])

    try:
        if os.path.exists(requirement_name):
            subprocess.check_output(["pip", "install", "-r", requirement_name])
        output = subprocess.check_output(command, stderr=subprocess.STDOUT, env=env)
        output = output.decode("utf-8")

        if "Detected Vulnerability : True" in output:
            result = "True"
        else:
            result = "False"
            
    except Exception as e:
        result = "False"
        output = str(e)
        log="None"
        return jsonify({"result": result, "msg" : output, "log" : log})
        
    with open("/app/logs/tmp_log.txt", "r") as f:
        log = f.read()
        
    return jsonify({"result": result, "msg" : output, "log" : log})

@app.route('/api/history/save', methods=['POST'])
def save_attack():
    data = request.get_json()
    attacks = data.get('attacks', [])

    try:
        for attack in attacks:
            cve = attack.get('cve')
            msg = attack.get('msg')
            result = attack.get('result')
            log = attack.get('log')
            timestamp = attack.get('timestamp')
            
            if not msg:
                msg = ""
            if not log:
                log = ""

            if cve:
                r.hset(f'history:{timestamp}', f'{cve}:msg', msg)
                r.hset(f'history:{timestamp}', f'{cve}:result', result)
                r.hset(f'history:{timestamp}', f'{cve}:log', log)

        return jsonify({"success": True})
    except Exception as e:
        return jsonify({"success": False, "msg" : e})
    
@app.route('/api/history/get', methods=['GET'])
def get_history():
    keys = r.keys("history:*")
    history = {}

    for key in keys:
        timestamp = key.split(":", 1)[1]
        if timestamp not in history:
            history[timestamp] = []

        cve_data = r.hgetall(key)
        for field, value in cve_data.items():
            cve_name, field_type = field.split(":", 1)
            cve_entry = next((item for item in history[timestamp] if item["cve"] == cve_name), None)
            if not cve_entry:
                cve_entry = {"cve": cve_name, "msg": None, "result": None, "log": None}
                history[timestamp].append(cve_entry)
            cve_entry[field_type] = value

    sorted_history = [{"timestamp": ts, "attacks": attacks} for ts, attacks in sorted(history.items(), reverse=True)]
    
    return jsonify({"history": sorted_history})

@app.route('/api/history/delete', methods=['POST'])
def delete_history():
    data = request.get_json()
    timestamp = data.get("timestamp")
    if timestamp:
        redis_key = f"history:{timestamp}"
        if r.exists(redis_key):
            r.delete(redis_key) 
            return jsonify({"success": True})
    return jsonify({"success": False, "message": "Failed to delete history"})

    
if __name__ == "__main__":
    app.run()